name: Build VCam Module

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3

    - name: Set up Android NDK
      id: setup-ndk
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25b

    - name: Prepare Headers (Mocks & Downloads)
      run: |
        # 1. Create Folder Structure
        mkdir -p aosp_headers/cutils
        mkdir -p aosp_headers/system
        mkdir -p aosp_headers/libhardware/include/hardware
        mkdir -p aosp_headers/system/media/camera/include/system
        
        # 2. Mock 'native_handle.h' (FIXED: Added buffer_handle_t)
        cat <<EOT >> aosp_headers/cutils/native_handle.h
        #ifndef NATIVE_HANDLE_H
        #define NATIVE_HANDLE_H
        typedef struct native_handle {
            int version;
            int numFds;
            int numInts;
            int data[0];
        } native_handle_t;
        typedef const native_handle_t* buffer_handle_t;
        #endif
        EOT

        # 3. Mock 'camera_metadata_hidden.h'
        cat <<EOT >> aosp_headers/system/camera_metadata_hidden.h
        #ifndef SYSTEM_CAMERA_METADATA_HIDDEN_H
        #define SYSTEM_CAMERA_METADATA_HIDDEN_H
        // Empty mock
        #endif
        EOT

        # 4. DOWNLOAD Real Hardware Headers (AOSP Mirror - Android 13)
        HW_BASE="https://raw.githubusercontent.com/aosp-mirror/platform_hardware_libhardware/android-13.0.0_r1/include/hardware"
        
        echo "Downloading hardware headers..."
        wget -O aosp_headers/libhardware/include/hardware/hardware.h "$HW_BASE/hardware.h"
        wget -O aosp_headers/libhardware/include/hardware/camera_common.h "$HW_BASE/camera_common.h"
        wget -O aosp_headers/libhardware/include/hardware/camera3.h "$HW_BASE/camera3.h"
        wget -O aosp_headers/libhardware/include/hardware/gralloc.h "$HW_BASE/gralloc.h"
        wget -O aosp_headers/libhardware/include/hardware/fb.h "$HW_BASE/fb.h"
        
        # 5. DOWNLOAD Metadata Headers (LineageOS Mirror - Android 11)
        MEDIA_BASE="https://raw.githubusercontent.com/LineageOS/android_system_media/lineage-18.1/camera/include/system"
        
        echo "Downloading metadata headers..."
        wget -O aosp_headers/system/media/camera/include/system/camera_metadata.h "$MEDIA_BASE/camera_metadata.h"
        wget -O aosp_headers/system/media/camera/include/system/camera_metadata_tags.h "$MEDIA_BASE/camera_metadata_tags.h"
        wget -O aosp_headers/system/media/camera/include/system/camera_vendor_tags.h "$MEDIA_BASE/camera_vendor_tags.h"
        
        # 6. DOWNLOAD System Core Headers (LineageOS 18.1)
        CORE_BASE="https://raw.githubusercontent.com/Lineag
