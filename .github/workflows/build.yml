name: Build VCam Module

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3

    - name: Set up Android NDK
      id: setup-ndk
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25b

    - name: Prepare Headers
      run: |
        mkdir -p aosp_headers/cutils
        mkdir -p aosp_headers/system
        mkdir -p aosp_headers/libhardware/include/hardware
        mkdir -p aosp_headers/system/media/camera/include/system
        
        # Mock native_handle.h
        echo "#ifndef NATIVE_HANDLE_H" > aosp_headers/cutils/native_handle.h
        echo "#define NATIVE_HANDLE_H" >> aosp_headers/cutils/native_handle.h
        echo "typedef struct native_handle { int version; int numFds; int numInts; int data[0]; } native_handle_t;" >> aosp_headers/cutils/native_handle.h
        echo "#endif" >> aosp_headers/cutils/native_handle.h

        # Mock camera_metadata_hidden.h
        echo "// Empty mock" > aosp_headers/system/camera_metadata_hidden.h
        
        # Download Hardware Headers (Android 13)
        HW_BASE="https://raw.githubusercontent.com/aosp-mirror/platform_hardware_libhardware/android-13.0.0_r1/include/hardware"
        wget -O aosp_headers/libhardware/include/hardware/hardware.h "$HW_BASE/hardware.h"
        wget -O aosp_headers/libhardware/include/hardware/camera_common.h "$HW_BASE/camera_common.h"
        wget -O aosp_headers/libhardware/include/hardware/camera3.h "$HW_BASE/camera3.h"
        
        # Download Metadata Headers (LineageOS 18.1)
        MEDIA_BASE="https://raw.githubusercontent.com/LineageOS/android_system_media/lineage-18.1/camera/include/system"
        wget -O aosp_headers/system/media/camera/include/system/camera_metadata.h "$MEDIA_BASE/camera_metadata.h"
        wget -O aosp_headers/system/media/camera/include/system/camera_metadata_tags.h "$MEDIA_BASE/camera_metadata_tags.h"
        wget -O aosp_headers/system/media/camera/include/system/camera_vendor_tags.h "$MEDIA_BASE/camera_vendor_tags.h"
        
        # Download System Headers (LineageOS 18.1)
        CORE_BASE="https://raw.githubusercontent.com/LineageOS/android_system_core/lineage-18.1/libsystem/include/system"
        wget -O aosp_headers/system/media/camera/include/system/camera.h "$CORE_BASE/camera.h"
        wget -O aosp_headers/system/media/camera/include/system/graphics.h "$CORE_BASE/graphics.h"
        wget -O aosp_headers/system/media/camera/include/system/graphics-base.h "$CORE_BASE/graphics-base.h"
        wget -O aosp_headers/system/media/camera/include/system/graphics-sw.h "$CORE_BASE/graphics-sw.h"

        # Download Window Header (LineageOS 18.1)
        NATIVE_BASE="https://raw.githubusercontent.com/LineageOS/android_frameworks_native/lineage-18.1/libs/nativewindow/include/system"
        wget -O aosp_headers/system/media/camera/include/system/window.h "$NATIVE_BASE/window.h"

        # Create Mock Graphics Version Headers
        touch aosp_headers/system/media/camera/include/system/graphics-base-v1.0.h
        touch aosp_headers/system/media/camera/include/system/graphics-base-v1.1.h
        touch aosp_headers/system/media/camera/include/system/graphics-base-v1.2.h

        # Patch camera_metadata.h
        TARGET_FILE="aosp_headers/system/media/camera/include/system/camera_metadata.h"
        sed -i '/#include <cutils\/compiler.h>/d' $TARGET_FILE
        sed -i '1i #ifndef ANDROID_API\n#define ANDROID_API\n#endif\n#ifndef CC_LIKELY\n#define CC_LIKELY( exp )  (__builtin_expect( !!(exp), 1 ))\n#define CC_UNLIKELY( exp )  (__builtin_expect( !!(exp), 0 ))\n#endif\n' $TARGET_FILE

    - name: Build Native Components
      run: |
        mkdir -p build
        cd build
        cmake -DANDROID_NDK=${{ steps.setup-ndk.outputs.ndk-path }} \
              -DCMAKE_TOOLCHAIN_FILE=${{ steps.setup-ndk.outputs.ndk-path }}/build/cmake/android.toolchain.cmake \
              -DANDROID_ABI=arm64-v8a \
              -DANDROID_PLATFORM=android-30 \
              -DCMAKE_BUILD_TYPE=Release \
              ..
        make

    - name: Build Companion App
      run: |
        gradle assembleRelease --no-daemon

    - name: Package Magisk Module
      run: |
        mkdir -p magisk_module/system/bin
        mkdir -p magisk_module/system/vendor/lib64/hw
        
        cp build/libcamera.qcom.vcam.so magisk_module/system/vendor/lib64/hw/camera.qcom.vcam.so || echo "SO file missing"
        cp build/cameraserver_proxy magisk_module/system/bin/vcam_receiver || echo "Binary missing"
        
        find . -name "*.apk" -exec cp {} magisk_module/VCam_Controller.apk \;
        
        cd magisk_module
        zip -r ../VCam_Magisk_Module.zip .

    - name: Upload Magisk Module
      uses: actions/upload-artifact@v4
      with:
        name: VCam_Magisk_Module
        path: VCam_Magisk_Module.zip

    - name: Upload Companion App
      uses: actions/upload-artifact@v4
      with:
        name: VCam_Controller_APK
        path: magisk_module/VCam_Controller.apk
