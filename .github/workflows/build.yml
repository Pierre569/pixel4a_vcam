name: Build VCam Module

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3

    - name: Set up Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25b

    - name: Generate Mock Android Headers (The Fix)
      run: |
        # 1. Create the folder structure
        mkdir -p aosp_headers/cutils
        mkdir -p aosp_headers/system

        # 2. Create mock native_handle.h (Required later)
        cat <<EOT >> aosp_headers/cutils/native_handle.h
        #ifndef NATIVE_HANDLE_H
        #define NATIVE_HANDLE_H
        typedef struct native_handle {
            int version;
            int numFds;
            int numInts;
            int data[0];
        } native_handle_t;
        #endif
        EOT

        # 3. Create mock camera_metadata_hidden.h
        cat <<EOT >> aosp_headers/system/camera_metadata_hidden.h
        #ifndef SYSTEM_CAMERA_METADATA_HIDDEN_H
        #define SYSTEM_CAMERA_METADATA_HIDDEN_H
        // Empty mock
        #endif
        EOT
        
        # 4. SURGICAL FIX: Patch camera_metadata.h
        # We assume the file exists in the repo. If not, we create a basic mock to prevent failure.
        if [ ! -f aosp_headers/system/media/camera/include/system/camera_metadata.h ]; then
           echo "Warning: camera_metadata.h not found in repo, creating mock."
           mkdir -p aosp_headers/system/media/camera/include/system
           touch aosp_headers/system/media/camera/include/system/camera_metadata.h
        fi

        # Use sed to DELETE the line that includes cutils/compiler.h
        # And inject the missing definitions directly into the file.
        TARGET_FILE="aosp_headers/system/media/camera/include/system/camera_metadata.h"
        
        # Remove the bad include
        sed -i '/#include <cutils\/compiler.h>/d' $TARGET_FILE
        
        # Inject the macros at the top of the file
        sed -i '1i #ifndef CC_LIKELY\n#define CC_LIKELY( exp )  (__builtin_expect( !!(exp), 1 ))\n#define CC_UNLIKELY( exp )  (__builtin_expect( !!(exp), 0 ))\n#endif\n' $TARGET_FILE
        
        echo "Patched camera_metadata.h successfully."

    - name: Build Native Components (C++)
      run: |
        mkdir -p build
        cd build
        cmake -DANDROID_NDK=$ANDROID_NDK_HOME \
              -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
              -DANDROID_ABI=arm64-v8a \
              -DANDROID_PLATFORM=android-30 \
              -DCMAKE_BUILD_TYPE=Release \
              ..
        make
      env:
        ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

    - name: Build Companion App (APK)
      run: |
        gradle assembleRelease --no-daemon

    - name: Package Magisk Module
      run: |
        mkdir -p magisk_module/system/bin
        mkdir -p magisk_module/system/vendor/lib64/hw
        
        # Copy the compiled C++ files
        # Check if file exists to avoid fail
        if [ -f build/libcamera.qcom.vcam.so ]; then
            cp build/libcamera.qcom.vcam.so magisk_module/system/vendor/lib64/hw/camera.qcom.vcam.so
        fi
        
        if [ -f build/cameraserver_proxy ]; then
            cp build/cameraserver_proxy magisk_module/system/bin/vcam_receiver
        fi
        
        # Copy the APK
        find . -name "*.apk" -exec cp {} magisk_module/VCam_Controller.apk \;
        
        # Zip it up
        cd magisk_module
        zip -r ../VCam_Magisk_Module.zip .
        cd ..

    - name: Upload Magisk Module
      uses: actions/upload-artifact@v4
      with:
        name: VCam_Magisk_Module
        path: VCam_Magisk_Module.zip

    - name: Upload Companion App
      uses: actions/upload-artifact@v4
      with:
        name: VCam_Controller_APK
        path: magisk_module/VCam_Controller.apk
