name: Build VCam Module

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3

    - name: Set up Android NDK
      id: setup-ndk
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25b

    - name: Prepare Headers (Mocks & Downloads)
      run: |
        # 1. Create Folder Structure
        mkdir -p aosp_headers/cutils
        mkdir -p aosp_headers/system
        mkdir -p aosp_headers/libhardware/include/hardware
        mkdir -p aosp_headers/system/media/camera/include/system
        
        # 2. Mock 'native_handle.h' (Required by hardware.h)
        cat <<EOT >> aosp_headers/cutils/native_handle.h
        #ifndef NATIVE_HANDLE_H
        #define NATIVE_HANDLE_H
        typedef struct native_handle {
            int version;
            int numFds;
            int numInts;
            int data[0];
        } native_handle_t;
        #endif
        EOT

        # 3. Mock 'camera_metadata_hidden.h'
        cat <<EOT >> aosp_headers/system/camera_metadata_hidden.h
        #ifndef SYSTEM_CAMERA_METADATA_HIDDEN_H
        #define SYSTEM_CAMERA_METADATA_HIDDEN_H
        // Empty mock
        #endif
        EOT

        # 4. DOWNLOAD Real Hardware Headers (The Fix for camera3.h)
        BASE_URL="https://raw.githubusercontent.com/aosp-mirror/platform_hardware_libhardware/android-11.0.0_r28/include/hardware"
        
        echo "Downloading hardware headers..."
        wget -q -O aosp_headers/libhardware/include/hardware/hardware.h $BASE_URL/hardware.h
        wget -q -O aosp_headers/libhardware/include/hardware/camera_common.h $BASE_URL/camera_common.h
        wget -q -O aosp_headers/libhardware/include/hardware/camera3.h $BASE_URL/camera3.h
        
        # 5. Patch camera_metadata.h (Fixing the cutils compiler error)
        # First, ensure the file exists (we mock it if missing, but usually download is better)
        # Let's download the real one too to be safe
        wget -q -O aosp_headers/system/media/camera/include/system/camera_metadata.h https://raw.githubusercontent.com/aosp-mirror/platform_system_media/android-11.0.0_r28/camera/include/system/camera_metadata.h

        # Now apply the surgical patch to remove the broken include
        TARGET_FILE="aosp_headers/system/media/camera/include/system/camera_metadata.h"
        sed -i '/#include <cutils\/compiler.h>/d' $TARGET_FILE
        sed -i '1i #ifndef CC_LIKELY\n#define CC_LIKELY( exp )  (__builtin_expect( !!(exp), 1 ))\n#define CC_UNLIKELY( exp )  (__builtin_expect( !!(exp), 0 ))\n#endif\n' $TARGET_FILE
        
        echo "Headers ready."

    - name: Build Native Components (C++)
      run: |
        mkdir -p build
        cd build
        cmake -DANDROID_NDK=${{ steps.setup-ndk.outputs.ndk-path }} \
              -DCMAKE_TOOLCHAIN_FILE=${{ steps.setup-ndk.outputs.ndk-path }}/build/cmake/android.toolchain.cmake \
              -DANDROID_ABI=arm64-v8a \
              -DANDROID_PLATFORM=android-30 \
              -DCMAKE_BUILD_TYPE=Release \
              ..
        make

    - name: Build Companion App (APK)
      run: |
        gradle assembleRelease --no-daemon

    - name: Package Magisk Module
      run: |
        mkdir -p magisk_module/system/bin
        mkdir -p magisk_module/system/vendor/lib64/hw
        
        if [ -f build/libcamera.qcom.vcam.so ]; then
            cp build/libcamera.qcom.vcam.so magisk_module/system/vendor/lib64/hw/camera.qcom.vcam.so
        fi
        
        if [ -f build/cameraserver_proxy ]; then
            cp build/cameraserver_proxy magisk_module/system/bin/vcam_receiver
        fi
        
        find . -name "*.apk" -exec cp {} magisk_module/VCam_Controller.apk \;
        
        cd magisk_module
        zip -r ../VCam_Magisk_Module.zip .
        cd ..

    - name: Upload Magisk Module
      uses: actions/upload-artifact@v4
      with:
        name: VCam_Magisk_Module
        path: VCam_Magisk_Module.zip

    - name: Upload Companion App
      uses: actions/upload-artifact@v4
      with:
        name: VCam_Controller_APK
        path: magisk_module/VCam_Controller.apk
