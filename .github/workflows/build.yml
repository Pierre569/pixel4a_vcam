name: Build VCam Module

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3

    - name: Set up Android NDK
      id: setup-ndk
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25b

    - name: Prepare Headers (Mocks & Downloads)
      run: |
        # 1. Create Folder Structure
        mkdir -p aosp_headers/cutils
        mkdir -p aosp_headers/system
        mkdir -p aosp_headers/libhardware/include/hardware
        mkdir -p aosp_headers/system/media/camera/include/system
        
        # 2. Mock 'native_handle.h'
        cat <<EOT >> aosp_headers/cutils/native_handle.h
        #ifndef NATIVE_HANDLE_H
        #define NATIVE_HANDLE_H
        typedef struct native_handle {
            int version;
            int numFds;
            int numInts;
            int data[0];
        } native_handle_t;
        typedef const native_handle_t* buffer_handle_t;
        #endif
        EOT

        # 3. Mock 'liblog'
        cat <<EOT >> aosp_headers/log/log.h
        #ifndef _LIBS_LOG_LOG_H
        #define _LIBS_LOG_LOG_H
        #include <android/log.h>
        #ifndef LOG_TAG
        #define LOG_TAG "VCam"
        #endif
        #define ALOGE(...) __android_log_print(ANDROID_LOG_ERROR, LOG_TAG, __VA_ARGS__)
        #define ALOGW(...) __android_log_print(ANDROID_LOG_WARN, LOG_TAG, __VA_ARGS__)
        #define ALOGI(...) __android_log_print(ANDROID_LOG_INFO, LOG_TAG, __VA_ARGS__)
        #define ALOGD(...) __android_log_print(ANDROID_LOG_DEBUG, LOG_TAG, __VA_ARGS__)
        #define ALOGV(...) __android_log_print(ANDROID_LOG_VERBOSE, LOG_TAG, __VA_ARGS__)
        #endif
        EOT

        # 4. Mock 'camera_metadata_hidden.h'
        cat <<EOT >> aosp_headers/system/camera_metadata_hidden.h
        #ifndef SYSTEM_CAMERA_METADATA_HIDDEN_H
        #define SYSTEM_CAMERA_METADATA_HIDDEN_H
        // Empty mock
        #endif
        EOT

        # 5. DOWNLOAD Real Hardware Headers (Android 13)
        HW_BASE="https://raw.githubusercontent.com/aosp-mirror/platform_hardware_libhardware/android-13.0.0_r1/include/hardware"
        
        echo "Downloading hardware headers..."
        wget -O aosp_headers/libhardware/include/hardware/hardware.h "$HW_BASE/hardware.h"
        wget -O aosp_headers/libhardware/include/hardware/camera_common.h "$HW_BASE/camera_common.h"
        wget -O aosp_headers/libhardware/include/hardware/camera3.h "$HW_BASE/camera3.h"
        wget -O aosp_headers/libhardware/include/hardware/gralloc.h "$HW_BASE/gralloc.h"
        wget -O aosp_headers/libhardware/include/hardware/fb.h "$HW_BASE/fb.h"
        
        # 6. DOWNLOAD Metadata Headers (LineageOS 11)
        MEDIA_BASE="https://raw.githubusercontent.com/LineageOS/android_system_media/lineage-18.1/camera/include/system"
        
        echo "Downloading metadata headers..."
        wget -O aosp_headers/system/media/camera/include/system/camera_metadata.h "$MEDIA_BASE/camera_metadata.h"
        wget -O aosp_headers/system/media/camera/include/system/camera_metadata_tags.h "$MEDIA_BASE/camera_metadata_tags.h"
        wget -O aosp_headers/system/media/camera/include/system/camera_vendor_tags.h "$MEDIA_BASE/camera_vendor_tags.h"
        
        # 7. DOWNLOAD System Core Headers (LineageOS 18.1)
        CORE_BASE="https://raw.githubusercontent.com/LineageOS/android_system_core/lineage-18.1/libsystem/include/system"
        
        echo "Downloading camera.h and graphics.h..."
        wget -O aosp_headers/system/media/camera/include/system/camera.h "$CORE_BASE/camera.h"
        wget -O aosp_headers/system/media/camera/include/system/graphics.h "$CORE_BASE/graphics.h"
        wget -O aosp_headers/system/media/camera/include/system/graphics-base.h "$CORE_BASE/graphics-base.h"
        wget -O aosp_headers/system/media/camera/include/system/graphics-sw.h "$CORE_BASE/graphics-sw.h"

        # 8. DOWNLOAD Window Header (LineageOS 18.1 Frameworks Native)
        NATIVE_BASE="https://raw.githubusercontent.com/LineageOS/android_frameworks_native/lineage-18.1/libs/nativewindow/include/system"
        wget -O aosp_headers/system/media/camera/include/system/window.h "$NATIVE_BASE/window.h"

        # 9. SMART-MOCK Graphics Version Headers
        cat <<EOT >> aosp_headers/system/media/camera/include/system/graphics-base-v1.0.h
        #ifndef GRAPHICS_BASE_V1_0_H
        #define GRAPHICS_BASE_V1_0_H
        #include <stdint.h>
        typedef int32_t android_pixel_format_t;
        typedef int32_t android_transform_t;
        typedef int32_t android_dataspace_t;
        typedef int32_t android_color_mode_t;
        typedef int32_t android_color_transform_t;
        typedef int32_t android_hdr_t;
        #endif
        EOT

        touch aosp_headers/system/media/camera/include/system/graphics-base-v1.1.h
        touch aosp_headers/system/media/camera/include/system/graphics-base-v1.2.h

        # 10. SURGICAL PATCH: Headers
        TARGET_FILE="aosp_headers/system/media/camera/include/system/camera_metadata.h"
        sed -i '/#include <cutils\/compiler.h>/d' $TARGET_FILE
        sed -i '1i #ifndef ANDROID_API\n#define ANDROID_API\n#endif\n#ifndef CC_LIKELY\n#define CC_LIKELY( exp )  (__builtin_expect( !!(exp), 1 ))\n#define CC_UNLIKELY( exp )  (__builtin_expect( !!(exp), 0 ))\n#endif\n' $TARGET_FILE
        
        echo "Headers ready."

    - name: Build Native Components (C++)
      run: |
        mkdir -p build
        cd build
        cmake -DANDROID_NDK=${{ steps.setup-ndk.outputs.ndk-path }} \
              -DCMAKE_TOOLCHAIN_FILE=${{ steps.setup-ndk.outputs.ndk-path }}/build/cmake/android.toolchain.cmake \
              -DANDROID_ABI=arm64-v8a \
              -DANDROID_PLATFORM=android-30 \
              -DCMAKE_BUILD_TYPE=Release \
              ..
        make

    # --- NEW STEP: Setup Stable Gradle Version ---
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: '8.4'

    - name: Build Companion App (APK)
      run: |
        gradle assembleRelease --no-daemon

    - name: Package Magisk Module
      run: |
        mkdir -p magisk_module/system/bin
        mkdir -p magisk_module/system/vendor/lib64/hw
        
        if [ -f build/libcamera.qcom.vcam.so ]; then
            cp build/libcamera.qcom.vcam.so magisk_module/system/vendor/lib64/hw/camera.qcom.vcam.so
        fi
        
        if [ -f build/cameraserver_proxy ]; then
            cp build/cameraserver_proxy magisk_module/system/bin/vcam_receiver
        fi
        
        find . -name "*.apk" -exec cp {} magisk_module/VCam_Controller.apk \;
        
        cd magisk_module
        zip -r ../VCam_Magisk_Module.zip .
        cd ..

    - name: Upload Magisk Module
      uses: actions/upload-artifact@v4
      with:
        name: VCam_Magisk_Module
        path: VCam_Magisk_Module.zip

    - name: Upload Companion App
      uses: actions/upload-artifact@v4
      with:
        name: VCam_Controller_APK
        path: magisk_module/VCam_Controller.apk
