name: Build VCam Module

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"
          cache: gradle

      - name: Setup Android NDK
        uses: android-actions/setup-android@v2

      - name: Install NDK
        run: sdkmanager --install "ndk;25.2.9519653" "cmake;3.22.1"

      - name: Fetch AOSP Headers
        run: |
          mkdir -p aosp_headers
          # Libhardware (camera3.h, camera_common.h)
          git clone --depth 1 https://android.googlesource.com/platform/hardware/libhardware -b android-13.0.0_r1 aosp_headers/libhardware
          # System Media (camera_metadata.h)
          git clone --depth 1 https://android.googlesource.com/platform/system/media -b android-13.0.0_r1 aosp_headers/system/media
          # Frameworks AV (camera_metadata definitions)
          git clone --depth 1 https://android.googlesource.com/platform/frameworks/av -b android-13.0.0_r1 aosp_headers/frameworks/av

      - name: Build Native Components (C++)
        run: |
          mkdir build
          cd build
          cmake -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
                -DANDROID_ABI=arm64-v8a \
                -DANDROID_PLATFORM=android-30 \
                ..
          cmake --build .
          # Move artifacts to root for zipping
          cp src/cameraserver_proxy ../cameraserver_proxy
          cp src/libcamera.qcom.vcam.so ../libvcam_wrapper.so || cp src/libvcam_wrapper.so ../libvcam_wrapper.so

      - name: Build Companion App (APK)
        working-directory: ./VCamController
        run: |
          # Use global gradle since wrapper is not committed
          # Generate Debug Keystore for Release build (or use debug build)
          # We'll use debug for simplicity as "Release" without keys fails signing
          gradle assembleDebug
          mv app/build/outputs/apk/debug/app-debug.apk ../VCamController.apk

      - name: Package Magisk Module
        run: |
          mkdir -p module_out/system/bin
          mkdir -p module_out/system/lib64/hw

          cp module.prop module_out/
          cp service.sh module_out/
          cp setup_audio.sh module_out/
          cp sepolicy.rule module_out/
          cp cameraserver_proxy module_out/system/bin/
          cp libvcam_wrapper.so module_out/system/lib64/hw/

          cd module_out
          zip -r ../pixel4a_vcam_magisk.zip .
          cd ..

      - name: Upload Magisk Module
        uses: actions/upload-artifact@v3
        with:
          name: VCam_Magisk_Module
          path: pixel4a_vcam_magisk.zip

      - name: Upload Companion App
        uses: actions/upload-artifact@v3
        with:
          name: VCam_Controller_APK
          path: VCamController.apk

      - name: Upload PC Tools
        uses: actions/upload-artifact@v3
        with:
          name: PC_Tools
          path: start_stream.bat
